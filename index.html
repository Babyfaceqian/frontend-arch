<!DOCTYPE html>
<meta charset="utf-8">
<style>
</style>
<canvas id="" width="800" height="500"></canvas>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
    var canvas = d3.select('canvas');
    var context = canvas.node().getContext('2d');
    var data = [];
    // 创建数据
    d3.range(2).forEach(function (el) {
        data.push({
            value: el
        });
    });

    // 绑定数据
    function dataBind(data) {
        data.forEach(function (d, index) {
            d.x = index * 100;
            d.y = index * 200;
        });
    }
    dataBind(data);
    // 创建元素
    var customBase = document.createElement('custom');
    var custom = d3.select(customBase);
    var join = custom.selectAll('custom.rect')
        .data(data);
    var enterSel = join.enter()
        .append('custom')
        .attr('class', 'rect')
        .attr("x", function (d, i) {
            return d.x;
        })
        .attr("y", function (d, i) {
            return d.y
        })
        .attr('width', 0)
        .attr('height', 0);
    join
        .merge(enterSel)
        .transition()
        .attr('width', 10)
        .attr('height', 10)
        .attr('fillStyle', function (d) {
            return 'black';
        });
    var exitSel = join.exit()
        .transition()
        .attr('width', 0)
        .attr('height', 0)
        .remove();
    // 创建缩放
    var _zoom = d3.zoom().on('zoom', function (d) {
        console.log('zooming');
        var transform = d3.event.transform;
        context.save();
        context.clearRect(0, 0, 800, 500);
        context.translate(transform.x, transform.y);
        context.scale(transform.k, transform.k);
        draw();
        context.restore();
    });
    canvas.call(_zoom);
    var elements = custom.selectAll('custom.rect');
    elements.on('click', function () {
        console.log('clicked!!')
    })
    // 绘制
    function draw() {
        elements.each(function (d, i) {
            var node = d3.select(this);
            context.fillStyle = node.attr('fillStyle');
            context.fillRect(node.attr('x'), node.attr('y'), node.attr('width'), node.attr('height'));
        });
    }

    // 第一次绘制
    draw();
</script>